## ðŸ§€ Challenge: **USB Malware Infection Analysis**

**Difficulty:** Medium  
**Category:** Forensics  

---

### ðŸ“œ Story:
Your friend has experienced a system crash and suspects a malware infection from a USB drive. You have a disk image and a timeline of events from the current year. Your task is to analyze the timeline and disk image to identify the malware, its persistence mechanism, and the initial infection vector.

How many USB drives did your friend use while restoring files to his system?

What is the created file in the root of the system?

What is the persistence mechanism used by the installed malware?

What command will be executed to lunch.exe?

What is the malicious application that has been installed on the system?

Which script file initially infected the machine after being ran? 

### Hint: 
```
It is not the same as the malware that runs in a persistent manner.
```
```
Flag: AzCTF{Number of USB drives_created.file_Command_malicious-application.exe}
```

---

### ðŸ“‹ Manual Walkthrough (Timeline & RegRipper Analysis):
---

#### 1. **How many USB drives did your friend use while restoring files to his system?**

**Step 1:** Analyze the timeline or perform a RegRipper analysis on the SYSTEM hive from the disk image.

**Step 2:** Identify the USB devices connected to the system by looking for entries related to USB storage devices (`usbstor`).

**Step 3:** Review the details of each USB device found, such as the device description, serial number, connection time, and friendly name.

**Step 4:** Count the number of unique USB devices identified.

**Conclusion:** **Three** USB drives were used while restoring files to the system. The details of these drives are as follows:
- **First USB Drive:**
  - Device: SanDisk Cruzer
  - Serial Number: 4C530001091022100104&0
  - Connection Time: Wed Nov 29 22:37:58 2017
- **Second USB Drive:**
  - Device: SanDisk Cruzer
  - Serial Number: 4C530001051023109270&0
  - Connection Time: Wed Nov 29 23:28:45 2017
- **Third USB Drive:**
  - Device: SanDisk Cruzer
  - Serial Number: 4C530001111023109282&0
  - Connection Time: Wed Nov 29 23:28:49 2017

---

#### 2. **What is the created file in the root of the system?**

**Step 1:** Examine the timeline for events related to file creation in the root directory.

**Step 2:** Identify any events that indicate the creation of a file in the root directory.

**Step 3:** Review the details of the identified event to determine the name of the created file.

**Conclusion:** The file created in the root of the system is named `debug.log`. This is evident from the timeline, which shows the creation of this file immediately after the execution of `schtasks.exe`.

---

#### 3. **What is the persistence mechanism used by the installed malware?**

**Step 1:** Analyze the timeline for events related to system persistence mechanisms, such as Scheduled Tasks, startup folders, or registry entries.

**Step 2:** Look for the creation or modification of Scheduled Tasks, as these are common persistence mechanisms.

**Step 3:** Identify the specific Scheduled Task that is associated with the malware.

**Step 4:** Review the details of the Scheduled Task, including the command executed and the trigger conditions.

**Conclusion:** The persistence mechanism used by the installed malware is a **Scheduled Task** named "EA Games Installer". This task is set to execute a command that launches `launch.exe` with Mimikatz commands to dump login passwords and maintain persistence on the system.

---

#### 4. **What command will be executed to launch `launch.exe`?**

**Step 1:** Locate the Scheduled Task associated with the malware in the timeline.

**Step 2:** Review the details of the Scheduled Task to find the command that is executed.

**Step 3:** Identify the specific command that launches `launch.exe`.

**Conclusion:** The command executed to launch `launch.exe` is:
```
cmd /c "C:\Documents and Settings\Administrator\Application Data\launch.exe" privilege::debug sekurlsa::logonpasswords exit >> C:\debug.log
```
This command runs `launch.exe` with Mimikatz commands to dump login passwords and logs the output to `debug.log`.

---

#### 5. **What is the malicious application that has been installed on the system?**

**Step 1:** Identify the executable file associated with the malware in the timeline.

**Step 2:** Locate the MD5 hash of the identified executable file.

**Step 3:** Use the MD5 hash to search for the application on VirusTotal or another malware database.

**Step 4:** Review the results to determine the name of the malicious application.

**Conclusion:** The malicious application installed on the system is **Mimikatz**. This is confirmed by the MD5 hash of `launch.exe`, which matches a known version of Mimikatz according to VirusTotal.

---

#### 6. **Which script file initially infected the machine after being run?**

**Step 1:** Analyze the timeline for events related to the initial infection of the machine.

**Step 2:** Look for the transfer or execution of script files, such as `.bat` or `.cmd` files.

**Step 3:** Identify the specific script file that was executed to initiate the infection.

**Step 4:** Review the details of the script file to confirm its role in the infection process.

**Conclusion:** The script file that initially infected the machine is `launch.bat`. This script was transferred in the `gamefiles` folder and was responsible for copying `warcraft-nocd.exe` to the `Application Data` folder as `launch.exe`, which is the persistently activated Mimikatz.

---

### ðŸŽ¯ Flag Format:
```
AzCTF{3_debug.log_C:\Documents and
Settings\Administrator\Application Data\launch.exe_Mimikatz_launch.bat}
```
